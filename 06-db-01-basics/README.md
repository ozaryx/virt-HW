# Домашнее задание к занятию "6.1. Типы и структура СУБД"

## Введение

Перед выполнением задания вы можете ознакомиться с 
[дополнительными материалами](https://github.com/netology-code/virt-homeworks/tree/master/additional/README.md).

## Задача 1

Архитектор ПО решил проконсультироваться у вас, какой тип БД 
лучше выбрать для хранения определенных данных.

Он вам предоставил следующие типы сущностей, которые нужно будет хранить в БД:

- Электронные чеки в json виде  
документоориентированная БД или ключ-значение БД - чек это документ или сложное значение, ключ это номер чека, либо хэш чека.

- Склады и автомобильные дороги для логистической компании
Графовая БД - склады - это узлы, дороги это связи, соединяющие склады. Для логистики очень важно быстро строить 
оптимальные маршруты между складами.

- Генеалогические деревья  
Иерархическое дерево - здесь явно видна иерархическая связь сущностей - родитель-потомок

- Кэш идентификаторов клиентов с ограниченным временем жизни для движка аутентификации
ключ-значение  
БД ключ-значение - ограниченное время хранения отлично походит для реализации InMemory БД, структура хранения ключ-значение.

- Отношения клиент-покупка для интернет-магазина  
Реляционная СУБД - сущности клиент и покупки связаны отношением клиент-покупки

Выберите подходящие типы СУБД для каждой сущности и объясните свой выбор.

## Задача 2

Вы создали распределенное высоконагруженное приложение и хотите классифицировать его согласно 
CAP-теореме. Какой классификации по CAP-теореме соответствует ваша система, если 
(каждый пункт - это отдельная реализация вашей системы и для каждого пункта надо привести классификацию):

- Данные записываются на все узлы с задержкой до часа (асинхронная запись)  
  (не обеспечивается консистентность)  
CAP: AP  
PACELC: PA EL  

- При сетевых сбоях, система может разделиться на 2 раздельных кластера  
  (обеспечивается поддержка разделения)  
CAP: CP либо AP  
PACELC: PC или PA  

- Система может не прислать корректный ответ или сбросить соединение  
  (не обеспечивается доступность)  
CAP: CP  
PACELC: PC EC  

А согласно PACELC-теореме, как бы вы классифицировали данные реализации?


## Задача 3

Могут ли в одной системе сочетаться принципы BASE и ACID? Почему?

Нет. Это две противостоящих парадигмы. Первая служит для построения высоконадежных систем, вторая высокопроизводительных.

## Задача 4

Вам дали задачу написать системное решение, основой которого бы послужили:

- фиксация некоторых значений с временем жизни
- реакция на истечение таймаута

Вы слышали о key-value хранилище, которое имеет механизм [Pub/Sub](https://habr.com/ru/post/278237/). 
Что это за система? Какие минусы выбора данной системы?

Это БД Redis.  
Redis довольно новая система и постоянно находится в стадии усовершенствований. Это накладывает свою специфику 
именно в отношении надежности. Известны массивные системы, реализованные на их базе, но для создания подобных систем 
обязательно нужны программисты хорошего уровня.


---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---

## Комментарии преподавателя

### 1 задание:

Электронные чеки в json виде:
Обычно для хранения json данных удобно использовать документоориентированная система управления базами данных, так как не требуется готовить описание таблиц. SQL тут не особо подходит, так как нужна будет новая абстракция - сериализованные данные. Это совсем не тот кейс.

Склады и автомобильные дороги для логистической компании:
Подразумевается связи с объектами. Склады — это узлы, а дороги между складами — это рёбра. У рёбер могут быть свойства — расстояние между складами, или, например, стоимость проезда для автомобилей разного типа. Необходимо предоставлять возможность поиска оптимального пути для решений задачи логистической компании.

Генеалогические деревья:
СУБД, как древовидная структура и узлы древа связаны между собой в отношениях родитель-потомок. У потомка может быть 2 или больше родителей.

Кэш идентификаторов клиентов с ограниченным временем жизни для движка аутентификации:
(NoSQL) СУБД типа ключ-значение. Позволяет хранить значения установленное количество времени. Какой есть пример БД?

Отношения клиент-покупка для интернет-магазина — реляционная (SQL):
СУБД с таблицами фактов (заказы) и измерений (клиенты, товары, продавцы).

### 2 задание:

1. Данные записываются на все узлы с задержкой до часа (асинхронная запись):
Подразумевается, что система всегда доступна, но узлы могут ответить не одинаково (данные не согласованы, но доступны и устойчивы к разделению (узлы между собой на общаются по пол часа, а в случае проблем, могут и больше не общаться. Самый классический пример - разделенный БД 1С. У них отдельный узел тоже может стоять где то в сторонке и синхронизироваться раз - два в день (ну или чаще/реже)
Теперь про PACELC: При сетевом разделении, базы доступны. и не консистентные, а вот в случае отсутствия разделения (Например базы синхронизируются в текущий момент) приоритеты не понятны, так что может быть как EL так и EC, хотя подсознательно ближе Latency

Ответ: AP PA/EL

2. При сетевых сбоях, система может разделиться на 2 раздельных кластера
На сомом деле, разделение кластера на 2 узла это как раз и является Partition Tolerance - та как система в первую очередь остаться живой, и случае каких то проблем будет отвечать всегда, и даже если кластер развалится, то отдельные узлы будут отвечать, но естественно не согласованно. Отказаться от PT (а значит, выбрать C и A) значит полагать, что система имеет идеальную связь и никогда не теряет сообщения между своими частями - в нашем случае это не так.
PACELC: При сетевом разделении, базы доступны. но не консистентные, в случае отсутствия разделения (Например базы синхронизируются в текущий момент) приоритеты не понятны, так что может быть как EL так и EC

PA PA/EL или PA/EС

3. Система может не прислать корректный ответ или сбросить соединение:
Если система не присылает ответ или сбрасывает соединение - значит у нее какие то проблемы. Если система живая, но часть узлов отвалилось, она решает просто игнорировать вопрошающих, что бы не дай бог не дать несогласованные данные. Некорректный ответ это например код возврата c описанием проблемы кластера ну или при запросе БД разрывает соединение - Ну по факту, она же отвечает. Но отрицательный результат - тоже результат. А вот Partition Tolerance она жертвует.
Отказаться от PT (а значит, выбрать C и A) значит полагать, что система имеет идеальную связь и никогда не теряет сообщения между своими частями - в нашем случае мы считаем именно так
Вообще это задание слишком расплывчато, и многие понимают решение по своему. Например, если бы вместо ответа был бы падение по таймауту, то тут уже явная жертва доступности, но ее тут нет). Подразумевается, что ИБ все таки отвечает, но не так как бы нам хотелось Хотя некоторые со мной в этом не согласны.
PACELC: При сетевом разделении, базы не доступны. но консистентные, в случае отсутствия разделения скорее всего будут готовы к задержкам, но сохранить консистентность - примеры VoltDB/H-Store и Megastore

Ответ: AC PC/EC

### 3 задание:

По идее, в одной системе сочетаться принципы BASE и ACID не могут.
ACID ориентирован на целостность данных, а BASE на их доступность.
Совместить два противоположных подхода в одной системе нереально.

### 4 задание:
Redis вообще-то не pub-sub система, а key-value data storage. Но он на удивление хорошо реализует классический pub-sub и показывает замечательную производительность. Но лучше его применять в простых решения, когда тащить еще один инструмент избыточно, а через редис можно например подписаться об успешной транзакции с банком.

Минусы Redis в качестве Pub/Sub системы:

Может медленно работать, если настроить персистентность
Без персистентности, можно потерять данные при сбое сервера или перезапуске сервиса
Настройка кластеризации может быть нетривиальна и требует особого внимания
Вашего ответа на работу достаточно, что бы принять работу
